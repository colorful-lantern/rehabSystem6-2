<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>マイリハビリ-きょう</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #c2e2ed;
            font-size: 16px;
        }

        #generalstatus {
            border-radius: 16px;
            padding-bottom: 0;
            position: relative;
            overflow: hidden;
            min-height: 350px;
            background: none !important;
        }

        .confetti {
            position: absolute;
            width: 1rem;
            height: 1rem;
            border-radius: 0.125rem;
            opacity: 0;
            pointer-events: none;
        }

        #dividestatus,
        #iconlegendstatus,
        #rankstatus {
            background: rgba(255, 255, 255, 1);
            border-radius: 16px 16px 16px 16px;
            padding-bottom: 0.75rem;
        }

        #container {
            background: #fff;
            border-radius: 50%;
            display: inline-block;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            width: 70vw;
            height: 70vw;
            max-width: 18.75rem;
            max-height: 18.75rem;
            position: relative; /* 紙吹雪エリアの位置基準用 */
        }

        .eachcontainer {
            background: #fff;
            border-radius: 0.75rem;
            margin: 0.25rem 0;
            min-height: 3rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0.5rem;
        }

        #generalstatus,
        #generalstatus *:not(i):not(.bi):not(.navbar):not(.navbar-brand):not(nav):not(#footer):not(.fixed-bottom):not(.btn) {
            font-size: 1.3rem;
        }
        #generalstatus .fw-bold,
        #generalstatus .m-auto.fw-bold.mb-2 {
            font-size: 1.1rem;
        }
        #generalstatus .eachcontainer {
            font-size: 1.05rem;
        }
        #dividestatus span {
            font-size: 0.92em !important;
        }

        /* 自主トレーニングボタンのスタイル */
        .self-training-btn-default {
            border-radius: 8px;
            font-size: 1rem;
            padding: 0.6rem;
            background-color: #f0f0f0;
            border-color: #dddddd;
            color: #808080;
            font-weight: bold;
        }
        
        .self-training-btn-completed {
            border-radius: 8px;
            font-size: 1rem;
            padding: 0.6rem;
            background-color: #e6f7e6;
            border-color: #d1f2d1;
            color: #155724;
            font-weight: bold;
        }

        /* 現在のランク表示用の吹き出しスタイル */
        .current-rank-indicator {
            position: relative;
            display: inline-block;
            padding: 4px 8px;
            background-color: #495057;
            color: white;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-top: 8px;
            white-space: nowrap;
        }
        
        .current-rank-indicator::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--indicator-color, #495057);
        }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: #c2e2ed;">
      <div class="container-fluid d-flex m-auto">
        <p class="navbar-brandfw-bold fw-bold fs-3 text-black ms-1 my-1 me-0" id="title">マイリハビリ</p>
      </div>
    </nav>

    <div class="" role="alert" id="reloadAlert"></div>

    <div id="generalstatus" class="m-2 text-center">
      <div id="container" class="my-4 mx-auto">
        <!-- プログレスバーの円の中で紙吹雪を舞わせるエリア -->
        <div id="cracker-animation-area-card" class="confetti-animation-area" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; overflow: hidden; pointer-events: none; z-index: 10; display: none;"></div>
      </div>

      <!-- 節目メッセージカード（表示条件がある場合のみ表示） -->
      <div id="milestone-message" class="p-3 my-2 text-center" style="max-width: 90%; margin: 0 auto; min-width: 16.25rem; background: rgba(255, 255, 255, 1); border-radius: 16px; display: none;">
        <div class="container-fluid">
          <div class="d-flex align-items-center justify-content-start mb-2">
            <div class="flex-shrink-0">
              <i class="bi bi-calendar-check text-primary" style="font-size: 2.5rem;"></i>
            </div>
            <div class="flex-grow-1 text-center ms-4">
              <span class="fw-bold text-primary" style="font-size: 1.3rem; line-height: 1.4;" id="milestone-message-text"></span>
            </div>
          </div>
        </div>
      </div>

      <div id="dividestatus" class="p-2 my-2 text-center" style="max-width: 90%; margin: 0 auto; min-width: 16.25rem;">
        <div class="container-fluid">
          <div class="text-start mb-2">
            <span class="fw-bold" style="font-size: 1.1rem;">今日のリハビリ</span>
          </div>
            <div class="row mb-1 justify-content-center text-center" id="rehab-row">
            <div class="col-6 px-1 rehab-block" data-rehab="rehabilitation1">
              <span style="font-size: 0.92em; white-space: nowrap;">理学療法</span>
              <div id="each0" class="eachcontainer"></div>
            </div>
            <div class="col-6 px-1 rehab-block" data-rehab="rehabilitation2">
              <span style="font-size: 0.92em; white-space: nowrap;">言語療法</span>
              <div id="each1" class="eachcontainer"></div>
            </div>
            <div class="col-6 px-1 rehab-block" data-rehab="rehabilitation3">
              <span style="font-size: 0.92em; white-space: nowrap;">作業療法</span>
              <div id="each2" class="eachcontainer"></div>
            </div>
            <div class="col-6 px-1 rehab-block" data-rehab="rehabilitation4">
              <span style="font-size: 0.92em; white-space: nowrap;">心理療法</span>
              <div id="each3" class="eachcontainer"></div>
            </div>
          </div>
          
          <!-- 自主トレーニングセクション -->
          <div class="row mb-1 justify-content-center text-center" id="self-training-section" style="display: none;">
            <div class="col-12 px-1">
              <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 0.92rem; color: #000000;">自主トレーニング</span>
              </div>
              <button id="self-training-btn" class="w-100 self-training-btn-default">
                <i class="bi bi-plus-circle me-2"></i>きろくする
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="rankstatus" class="p-2 my-2 text-center" style="max-width: 90%; margin: 0 auto; min-width: 16.25rem;">
        <div class="container-fluid">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold" style="font-size: 1.2rem;">あなたのランク</span>
            <span class="fw-bold badge rounded-pill" style="font-size: 1.4rem;"></span>
          </div>
          <div class="progress mb-1 mt-3" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: 60%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="d-flex align-baseline justify-content-end m-0 p-0" style="font-size: 1rem; color: #666; transition: opacity 0.4s ease-in-out;"></div>
          
          <!-- ランクアイコン表示 -->
          <!-- <div class="mt-3 mb-2">
            <div class="table-responsive">
              <table class="table table-borderless m-auto" style="max-width: 400px;">
                <tbody>
                  <tr id="rank-names-row">
                    <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #495057; font-size: 0.8rem;">ビギナー</span></td>
                    <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #b8860b; font-size: 0.8rem;">ブロンズ</span></td>
                    <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #708090; font-size: 0.8rem;">シルバー</span></td>
                    <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #daa520; font-size: 0.8rem;">ゴールド</span></td>
                    <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #4a4a4a; font-size: 0.8rem;">プラチナ</span></td>
                  </tr>
                  <tr id="rank-status-row-index"> -->
                    <!-- ランクアイコン/ステータスがここに動的に挿入されます -->
                  <!-- </tr>
                </tbody>
              </table>
            </div>
          </div> -->
          
          <!-- バッジを見るボタン -->
          <div class="mt-2" id="rank-info">
            <div class="text-center">
              <button id="rankDetailsBtn" class="btn btn-outline-primary" style="border-radius: 8px; font-size: 1rem; padding: 0.6rem 1.2rem;">
                <i class="bi bi-award me-2"></i>バッジを見る
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- <div id="iconlegendstatus" class="p-2 mt-2 text-center" style="max-width: 90%; margin: 0 auto; min-width: 16.25rem;">
          <div class="container-fluid m-0 p-0">
            <button class="btn btn-link text-secondary fw-bold ms-1" type="button"
              data-bs-toggle="collapse" data-bs-target="#icon-legend"
              aria-expanded="false" aria-controls="icon-legend"
              style="text-decoration:none; font-size:1.1rem;">
              アイコンの意味 <span id="icon-legend-arrow">▼</span>
            </button>
            <div class="collapse" id="icon-legend">
              <table class="table table-borderless m-auto align-middle" style="max-width: 400px;">
                <tbody>
                  <tr>
                    <td class="text-center align-middle" style="width: 48px; vertical-align: middle;">
                      <i class="bi bi-x-circle fs-4 text-secondary"></i>
                    </td>
                    <td class="text-start align-middle fs-6" style="vertical-align: middle;">
                      まだリハビリに取り組んでいません。
                    </td>
                  </tr>
                  <tr>
                    <td class="text-center align-middle" style="width: 48px; vertical-align: middle;">
                      <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                    </td>
                    <td class="text-start align-middle fs-6" style="vertical-align: middle;">
                      リハビリに取り組みました。
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div> -->
      
    <!-- 自主トレーニング記録モーダル -->
    <div class="modal fade" id="selfTrainingModal" tabindex="-1" aria-labelledby="selfTrainingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="selfTrainingModalLabel">
              <i class="bi bi-journal-text me-2" style="color: #6f42c1;"></i>
              自主トレーニング記録
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="selfTrainingText" class="form-label">きょうの自主トレーニングの内容</label>
              <textarea class="form-control" id="selfTrainingText" rows="4" 
                        maxlength="200" placeholder="例：30分間のストレッチを行いました。" style="border-color: #b0b0b0;"></textarea>
              <div class="form-text">
                <span id="charCount">0</span>/200文字
              </div>
            </div>
            <div class="alert alert-info" role="alert">
              <i class="bi bi-info-circle me-2"></i>
              文章は90日間保存されます。
            </div>
          </div>
          <div class="modal-footer">
            <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button> -->
            <button type="button" class="btn btn-danger me-auto" id="deleteSelfTraining" style="display: none;">
              <i class="bi bi-trash me-2"></i>記録を消す
            </button>
            <button type="button" class="btn btn-primary" id="saveSelfTraining">
              <i class="bi bi-check-circle me-2"></i>記録する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ランク詳細モーダル -->
    <div class="modal fade" id="rankDetailsModal" tabindex="-1" aria-labelledby="rankDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="rankDetailsModalLabel">
              <i class="bi bi-award me-2" style="color: #daa520;"></i>
              ランク・バッジ詳細
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- ランク一覧テーブル -->
            <div class="mb-4">
              <div class="text-start mb-3">
                <span class="fw-bold" style="font-size: 1.3rem;">ランク一覧</span>
              </div>
              <div class="table-responsive">
                <table class="table table-borderless m-auto" style="max-width: 400px;">
                  <tbody>
                    <tr id="rank-names-row-modal">
                      <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #495057; font-size: 0.9rem;">ビギナー</span></td>
                      <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #b8860b; font-size: 0.9rem;">ブロンズ</span></td>
                      <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #708090; font-size: 0.9rem;">シルバー</span></td>
                      <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #daa520; font-size: 0.9rem;">ゴールド</span></td>
                      <td class="text-center p-1"><span class="badge rounded-pill text-white" style="background-color: #4a4a4a; font-size: 0.9rem;">プラチナ</span></td>
                    </tr>
                    <tr id="rank-status-row-modal">
                      <!-- ランクアイコン/ステータスがここに動的に挿入されます -->
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- ランクについてのアコーディオン -->
            <div class="mt-3">
              <div class="container-fluid m-0 p-0">
                <button class="btn btn-link text-secondary fw-bold ms-1" type="button"
                  data-bs-toggle="collapse" data-bs-target="#rank-explanation-modal"
                  aria-expanded="false" aria-controls="rank-explanation-modal"
                  style="text-decoration:none; font-size:1.2rem;">
                  ランクについて <span id="rank-explanation-arrow-modal">▼</span>
                </button>
                <div class="collapse" id="rank-explanation-modal">
                  <div class="card mt-2" style="border-radius: 12px;">
                    <div class="card-body">
                      <h6 class="card-title text-center"><i class="bi bi-award fs-4"></i> ランクシステム</h6>
                      <p class="card-text text-center" style="font-size: 1.1rem;">1日のリハビリをすべて完了すると1ポイントたまります。<br>合計ポイントに応じて、5つのランクが用意されています。</p>
                      
                      <!-- ランク一覧 -->
                      <div class="alert alert-info m-1 p-3">
                        <div class="text-center">
                          <strong style="font-size: 1.1rem;">ランク一覧</strong><br>
                          <div style="font-size: 1rem; line-height: 2; margin-top: 12px;">
                            <span class="badge rounded-pill text-white" style="background-color: #495057; font-size: 1rem;">ビギナー</span>：0〜9ポイント<br>
                            <span class="badge rounded-pill text-white" style="background-color: #b8860b; font-size: 1rem;">ブロンズ</span>：10〜29ポイント<br>
                            <span class="badge rounded-pill text-white" style="background-color: #708090; font-size: 1rem;">シルバー</span>：30〜59ポイント<br>
                            <span class="badge rounded-pill text-white" style="background-color: #daa520; font-size: 1rem;">ゴールド</span>：60〜99ポイント<br>
                            <span class="badge rounded-pill text-white" style="background-color: #4a4a4a; font-size: 1rem;">プラチナ</span>：100ポイント以上
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <div id="footer" class="container-fluid">
      <div class="fixed-bottom bg-white m-auto"
           style="border-radius: 26px; left: 0; right: 0; width: 95%; max-width: 600px; bottom: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.18);">
        <div class="row m-auto p-0" style="border-radius: 16px;">
          <div class="col-3">
            <div id="homebtn" class="text-center m-auto">
              <a href="index.html" class="btn btn-link text-primary text-decoration-none text-nowrap" style="font-size: 1.2rem;">
                <i class="bi bi-house-fill fw-bold" style="font-size: 2rem;"></i><br>
              きょう</a>
            </div>
          </div>
          <div class="col-3">
            <div id="calbtn" class="text-center m-auto">
              <a href="calender.html" class="btn btn-link text-black text-decoration-none text-nowrap" style="font-size: 1.2rem;">
                <i class="bi bi-calendar2-week fw-bold" style="font-size: 2rem;"></i><br>
              きろく</a>
            </div>
          </div>
          <div class="col-3">
            <div id="explainbtn" class="text-center m-auto">
              <a href="explain.html" class="btn btn-link text-black text-decoration-none text-nowrap" style="font-size: 1.2rem;">
                <i class="bi bi-question-circle fw-bold" style="font-size: 2rem;"></i><br>
              使い方</a>
            </div>
          </div>
          <div class="col-3">
            <div id="settingbtn" class="text-center m-auto">
              <a href="setting.html" class="btn btn-link text-black text-decoration-none text-nowrap" style="font-size: 1.2rem;">
              <i class="bi bi-gear-fill fw-bold" style="font-size: 2rem;"></i><br>
              設定</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div style="height: 200px;"></div>

    
    <script src="js/config.js"></script>
    <script src="js/progressbar.js"></script>
    <script src="js/js_index/checkURL.js"></script>
    <script src="js/js_index/checkReserve.js"></script>
    <script src="js/js_index/checkLimited.js"></script>
    <script src="js/script.js"></script>
    <!-- <script src="js/self_training_test.js"></script> -->
    
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // アクセスした日付をローカルストレージのkey=lastAccessTimeにtoString()で保存
            const today = new Date();
            localStorage.setItem('lastAccessTime', today.getTime());

            const confettiContainer = document.getElementById('cracker-animation-area-card');
            const generalStatus = document.getElementById('generalstatus');
            let confettiIntervalId = null;

            const confettiColors = [
                '#FFD700', '#FF69B4', '#00CED1', '#7FFF00', '#FF8C00', '#9370DB', 
                '#FFFF00', '#ADFF2F', '#1E90FF', '#FA8072', '#BA55D3', '#00FA9A', 
                '#FFDAB9', '#6495ED', '#FFDEAD'
            ];

            function createConfetti() {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = confettiColors[anime.random(0, confettiColors.length - 1)];
                
                // 円の上部からランダムな水平位置で開始
                confetti.style.left = `${anime.random(0, confettiContainer.offsetWidth - 8)}px`;
                confetti.style.top = `-10px`;
                confettiContainer.appendChild(confetti);

                anime({
                    targets: confetti,
                    translateY: confettiContainer.offsetHeight + 10, // 上から下へ落下
                    translateX: anime.random(-20, 20), // 少し左右に揺れる
                    rotate: anime.random(0, 720), // 回転
                    opacity: [1, 0.5, 0], // 透明度変化
                    duration: anime.random(1000, 2000), // 落下時間を短縮（速度アップ）
                    easing: 'linear', // 自由落下
                    complete: function(anim) {
                        anim.animatables[0].target.remove();
                    }
                });
            }

            const checkAndTriggerConfetti = () => {
                const nmboftrue = parseInt(localStorage.getItem('nmboftrue'), 10);
                const numberofClass = parseInt(localStorage.getItem('numberofClass'), 10);
                const conditionMet = !isNaN(nmboftrue) && !isNaN(numberofClass) && nmboftrue === numberofClass;

                if (conditionMet) {
                    confettiContainer.style.display = 'block';
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = '#c2e2ed';

                    if (confettiIntervalId === null) {
                        confettiIntervalId = setInterval(createConfetti, 120); // 間隔を短くして数を増やす
                    }
                } else {
                    confettiContainer.style.display = 'none';
                    document.body.style.backgroundColor = '#c2e2ed';
                    document.body.style.backgroundImage = 'radial-gradient(circle, #ffffff 12px, transparent 5px),';
                    document.body.style.backgroundSize = '40px 40px, 60px 60px, 90px 90px';
                    document.body.style.backgroundPosition = '0 0, 20px 20px, 45px 45px';

                    if (confettiIntervalId !== null) {
                        clearInterval(confettiIntervalId);
                        confettiIntervalId = null;
                        const existingConfetti = confettiContainer.querySelectorAll('.confetti');
                        existingConfetti.forEach(c => c.remove());
                    }
                }
            };

            checkAndTriggerConfetti();
            
            // 休日当日の表示制御を最初に実行
            if (typeof handleRestDayDisplay === 'function') {
                try {
                    handleRestDayDisplay();
                } catch (error) {
                    console.error('休日表示処理エラー:', error);
                }
            }
            
            // 注意: 連続記録メッセージと節目メッセージの表示は
            // script.jsのDOMContentLoadedイベントで一元管理されます
            
            setInterval(() => {
                checkAndTriggerConfetti();
                // 節目メッセージは定期更新しない（その日の間は固定表示）
            }, 5000);
        });
    </script>
    
    <!-- 自主トレーニング機能 -->
    <script>
        // 自主トレーニング機能の初期化
        document.addEventListener('DOMContentLoaded', function() {
            const selfTrainingSection = document.getElementById('self-training-section');
            const selfTrainingBtn = document.getElementById('self-training-btn');
            const selfTrainingModal = new bootstrap.Modal(document.getElementById('selfTrainingModal'));
            const selfTrainingText = document.getElementById('selfTrainingText');
            const charCount = document.getElementById('charCount');
            const saveSelfTrainingBtn = document.getElementById('saveSelfTraining');
            
            // 自主トレーニングが有効かチェック
            function checkSelfTrainingEnabled() {
                const isEnabled = localStorage.getItem(SELF_TRAINING_CONFIG.REHAB_KEY) === 'true';
                if (isEnabled) {
                    selfTrainingSection.style.display = 'block';
                    updateSelfTrainingButton();
                } else {
                    selfTrainingSection.style.display = 'none';
                }
            }
            
            // 自主トレーニングボタンの状態更新
            function updateSelfTrainingButton() {
                const today = new Date().toISOString().split('T')[0];
                const hasRecord = SelfTrainingManager.hasRecord(today);
                
                if (hasRecord) {
                    selfTrainingBtn.innerHTML = '<i class="bi bi-check-circle-fill me-2 text-success"></i>記録済み';
                    selfTrainingBtn.className = 'btn w-100 self-training-btn-completed';
                    selfTrainingBtn.disabled = false; // 再編集可能
                } else {
                    selfTrainingBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>記録する';
                    selfTrainingBtn.className = 'btn w-100 self-training-btn-default';
                    selfTrainingBtn.disabled = false;
                }
            }
            
            // 文字数カウント
            selfTrainingText.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                
                if (count > 200) {
                    charCount.style.color = '#dc3545';
                } else if (count > 150) {
                    charCount.style.color = '#ffc107';
                } else {
                    charCount.style.color = '#6c757d';
                }
            });
            
            // 自主トレーニングボタンクリック
            selfTrainingBtn.addEventListener('click', function() {
                const today = new Date().toISOString().split('T')[0];
                const existingText = SelfTrainingManager.getTextContent(today) || '';
                const deleteSelfTrainingBtn = document.getElementById('deleteSelfTraining');
                
                // 既存のテキストがあれば表示
                selfTrainingText.value = existingText;
                charCount.textContent = existingText.length;
                
                // 削除ボタンの表示制御
                if (existingText || SelfTrainingManager.hasRecord(today)) {
                    deleteSelfTrainingBtn.style.display = 'inline-block';
                } else {
                    deleteSelfTrainingBtn.style.display = 'none';
                }
                
                selfTrainingModal.show();
            });
            
            // 削除ボタンクリック
            const deleteSelfTrainingBtn = document.getElementById('deleteSelfTraining');
            deleteSelfTrainingBtn.addEventListener('click', function() {
                if (confirm('今日の自主トレーニング記録を削除しますか？')) {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // 記録削除
                    const deleteResult = SelfTrainingManager.deleteRecord(today);
                    
                    if (deleteResult) {
                        selfTrainingModal.hide();
                        updateSelfTrainingButton();
                        
                        // 3秒後に自動削除
                        setTimeout(() => {
                            if (successAlert.parentNode) {
                                successAlert.remove();
                            }
                        }, 3000);

                        // index.html?each4=deleteにリダイレクト
                        window.location.href = 'index.html?each4=delete';
                        
                        // // プログレスバーや統計の更新をトリガー
                        // if (typeof saveTrueCountToLocalStorage === 'function') {
                        //     saveTrueCountToLocalStorage();
                        // }



                    } else {
                        alert('記録の削除に失敗しました。もう一度お試しください。');
                    }
                }
            });
            
            // 記録保存
            saveSelfTrainingBtn.addEventListener('click', function() {
                const text = selfTrainingText.value.trim();
                const today = new Date().toISOString().split('T')[0];
                
                if (text.length === 0) {
                    alert('記録内容を入力してください。');
                    return;
                }
                
                if (text.length > 200) {
                    alert('記録内容は200文字以内で入力してください。');
                    return;
                }
                
                // 記録保存
                const saveResult = SelfTrainingManager.saveRecord(today, text);
                
                if (saveResult) {
                    selfTrainingModal.hide();
                    updateSelfTrainingButton();
                    
                    // 成功メッセージ
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successAlert.style.cssText = 'position: fixed; left: 50%; top: 10%; transform: translate(-50%, -50%); z-index: 9999; max-width: 700px;';
                    successAlert.innerHTML = `
                        <i class="bi bi-check-circle-fill me-2"></i>
                        自主トレーニングを記録しました！
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successAlert);
                    
                    // 3秒後に自動削除
                    setTimeout(() => {
                        if (successAlert.parentNode) {
                            successAlert.remove();
                        }
                    }, 3000);
                    
                    // プログレスバーや統計の更新をトリガー
                    if (typeof saveTrueCountToLocalStorage === 'function') {
                        saveTrueCountToLocalStorage();
                    }
                } else {
                    alert('記録の保存に失敗しました。もう一度お試しください。');
                }
            });
            
            // 初期状態のチェック
            if (typeof SELF_TRAINING_CONFIG !== 'undefined') {
                checkSelfTrainingEnabled();
                
                // 設定変更を監視（定期チェック）
                setInterval(checkSelfTrainingEnabled, 1000);
            }
        });
    </script>
    
    <!-- ランク詳細モーダル用スクリプト -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ランク詳細ボタンとモーダルの初期化
            const rankDetailsBtn = document.getElementById('rankDetailsBtn');
            const rankDetailsModal = new bootstrap.Modal(document.getElementById('rankDetailsModal'));
            
            // ボタンクリックでモーダル表示
            if (rankDetailsBtn) {
                rankDetailsBtn.addEventListener('click', function() {
                    // モーダル内のランクステータス行を更新
                    updateModalRankStatus();
                    rankDetailsModal.show();
                });
            }
            
            // モーダル内のランクステータスを更新する関数
            function updateModalRankStatus() {
                const modalRankStatusRow = document.getElementById('rank-status-row-modal');
                
                if (modalRankStatusRow) {
                    // script.jsの関数を直接呼び出してランクアイコンを生成
                    if (typeof updateIndexRankDisplay === 'function') {
                        // 一時的にメインページの要素を作成してランクアイコンを生成
                        const tempElement = document.createElement('tr');
                        tempElement.id = 'rank-status-row-index';
                        document.body.appendChild(tempElement);
                        
                        // ランク表示を更新
                        updateIndexRankDisplay();
                        
                        // 生成されたコンテンツをモーダルにコピー
                        modalRankStatusRow.innerHTML = tempElement.innerHTML;
                        
                        // 一時要素を削除
                        document.body.removeChild(tempElement);
                    } else {
                        // フォールバック: 基本的なランクアイコンを表示
                        generateBasicRankIcons(modalRankStatusRow);
                    }
                }
            }
            
            // 基本的なランクアイコンを生成する関数（フォールバック用）
            function generateBasicRankIcons(targetRow) {
                const ranks = [
                    { name: 'ビギナー', icon: '🥉', color: '#495057' },
                    { name: 'ブロンズ', icon: '🥉', color: '#b8860b' },
                    { name: 'シルバー', icon: '🥈', color: '#708090' },
                    { name: 'ゴールド', icon: '🥇', color: '#daa520' },
                    { name: 'プラチナ', icon: '👑', color: '#4a4a4a' }
                ];
                
                let html = '';
                ranks.forEach((rank, index) => {
                    html += `<td class="text-center p-1">
                        <span style="font-size: 1.5rem;">${rank.icon}</span>
                    </td>`;
                });
                
                targetRow.innerHTML = html;
            }
            
            // モーダル内のアコーディオン制御
            const collapseElModal = document.getElementById('rank-explanation-modal');
            const arrowModal = document.getElementById('rank-explanation-arrow-modal');
            
            if (collapseElModal && arrowModal) {
                collapseElModal.addEventListener('show.bs.collapse', function () {
                    arrowModal.textContent = '▲';
                });
                collapseElModal.addEventListener('hide.bs.collapse', function () {
                    arrowModal.textContent = '▼';
                });
            }
        });
    </script>
    
    <!-- <script>
      document.addEventListener('DOMContentLoaded', function() {
        var collapseEl = document.getElementById('icon-legend');
        var arrow = document.getElementById('icon-legend-arrow');
        collapseEl.addEventListener('show.bs.collapse', function () {
          arrow.textContent = '▲';
        });
        collapseEl.addEventListener('hide.bs.collapse', function () {
          arrow.textContent = '▼';
        });
      });
    </script> -->
  </body>
</html>
